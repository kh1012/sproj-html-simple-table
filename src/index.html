<!DOCTYPE html>
<html lang="kr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://raw.githubusercontent.com/kh1012/sproj-std/main/files/favicon.ico" />
  <title>html simple table</title>
</head>
<body style="padding: 10px">
  <!-- SCRIPT 동작 코드 -->
  <script type=""text/javascript">
    // API를 사용하기 위한 기본적인 변수 및 함수
    const baseUrl = 'https://api-beta.rpm.kr-dv-midasit.com:443';
    const programType = 'gen';
    function getMapiKey() {
      // url에서 params를 가져오고 mapikey를 get 합니다.
      const params = new URLSearchParams(window.location.search);
      return params.get("mapikey");
    }

    // QueryString을 만드는 함수
    function makeQueryString() {
      const inputValue = document.getElementById('querystring-input').value;
      const queryString = '?mapikey=' + inputValue;
      document.getElementById('querystring-output').textContent = queryString;
    }

    // 만들어진 QueryString을 주소창에 적용 시켜주는 함수
    function queryStringToURL() {
      const href = window.location.href;
      if (!href.includes('?mapikey=')) {
        window.location.href = 
          window.location.href + document.getElementById('querystring-output').textContent;
      }
    }

    // MAPI-Key가 올바른지 확인하는 함수
    function checkMapiKey() {
      async function doWork() {
        // mapikey를 QueryString으로부터 가져 옵니다.
        const mapikey = getMapiKey();

        const response = await fetch(`${baseUrl}/mapikey/verify`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'MAPI-Key': mapikey
          }
        });

        // 응답 결과를 getnode-output id를 가진 DOM 객체에 전달합니다.
        document.getElementById('status-output').textContent = 
          JSON.stringify(await response.json(), null, 2);
      }

      doWork();      
    }

    //GET NODE 버튼 클릭 시 동작
    function getNodeFetch() {
      async function doWork() {
        const mapikey = getMapiKey();
        const response = await fetch(`${baseUrl}/${programType}/db/node`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'MAPI-Key': mapikey
        }});
  
        //TABLE 기본 구조 생성, HEADER, 동적으로 생성 할 BODY 마킹
        const table = `
        <table style="margin-top: 10px">
          <thead>
            <tr>
              <th>NODE</th>
              <th>x</th>
              <th>y</th>
              <th>z</th>
            </tr>
          </thead>
          @BodyMask
        </table>`;

        //XYZ값을 이용해 TABLE BODY부분을 추가
        const data = await response.json();
        const nodes = data["NODE"];
        const rows = document.createElement("tbody");
        for (const key of Object.keys(nodes)) {
          //TABLE Row를 생성
          const row = document.createElement("tr");

          //ID Column 생성
          const id = document.createElement("td");
          id.innerHTML = key;
          row.appendChild(id);

          //NODE X, Y, Z Column 생성
          for (const coord of [ nodes[key].X, nodes[key].Y, nodes[key].Z ]) {
            const col = document.createElement("td");
            col.innerHTML = coord;
            row.appendChild(col);
          }

          //Row 추가
          rows.appendChild(row);
        }

        //BODY 마킹 부분을 생성한 BODY로 치환한다
        document.getElementById("getnode-output").innerHTML = table.replace('@BodyMask', rows.outerHTML);
      }

      doWork();
    }
  </script>

  <div>
    <!-- TITLE -->
    <h1>HTML SIMPE TABLE</h1>

    <!-- EXAMPLE -->
    <ul>
      <li style="margin-bottom: 10px">
        아래 Edit Box에 MAPI-Key를 넣고 <b>QueryString을 만들어 보세요.</b>
        <div style="margin-top: 10px; margin-bottom: 10px">
          <input type="text" id="querystring-input" />
          <button type="button" style="margin-left: 10px" onclick="makeQueryString()">QueryString 만들기</button>
          <pre id='querystring-output' style="margin-bottom: 10px"></pre>
          <p>위 문자열을 복사해서 주소창에 직접 붙여넣기 + Enter 하시거나 <button type="button" onclick="queryStringToURL()">QueryString 적용하기 (To URL)</button>를 눌러주세요.</p>
          <p>브라우저의 주소창을 보시면 MAPI-Key가 적용된 걸 보실 수 있습니다.</p>
        </div>
      </li>
      <li style="margin-bottom: '10px'">
        MAPI-Key가 올바른 형태인지 확인하세요.
        <div style="margin-top: 10px">
          <button type="button" onclick="checkMapiKey()">MAPI-Key 확인</button>
          <pre id='status-output'></pre>
        </div>
      </li>
      <!-- NODE 데이터를 TABLE로 출력 -->
      <li>
        <b>"GET"</b> NODE 정보를 가져와서 <b>테이블</b>로 출력합니다.
        <!-- TABLE 스타일 변경 -->
        <style>
          table, td, th { border: 1px solid #000; border-collapse: collapse; text-align: center; padding: 5px; }
        </style>
        <!-- TABLE 출력 -->
        <div style="margin-top: 10px">
          <button type="button" onclick="getNodeFetch()">GET NODE TABLE</button>
          <div id="getnode-output" />
        </div>
      </li>
    </ul>
  </div>
</body>
</html>